{"ast":null,"code":"var __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nimport { toArray } from './util';\nimport { shouldEmbed, embedResources } from './embedResources';\nconst cssFetchCache = {};\n\nfunction fetchCSS(url) {\n  const cache = cssFetchCache[url];\n\n  if (cache != null) {\n    return cache;\n  }\n\n  const deferred = window.fetch(url).then(res => ({\n    url,\n    cssText: res.text()\n  }));\n  cssFetchCache[url] = deferred;\n  return deferred;\n}\n\nfunction embedFonts(meta) {\n  return __awaiter(this, void 0, void 0, function* () {\n    return meta.cssText.then(raw => {\n      let cssText = raw;\n      const regexUrl = /url\\([\"']?([^\"')]+)[\"']?\\)/g;\n      const fontLocs = cssText.match(/url\\([^)]+\\)/g) || [];\n      const loadFonts = fontLocs.map(location => {\n        let url = location.replace(regexUrl, '$1');\n\n        if (!url.startsWith('https://')) {\n          url = new URL(url, meta.url).href;\n        } // eslint-disable-next-line promise/no-nesting\n\n\n        return window.fetch(url).then(res => res.blob()).then(blob => new Promise((resolve, reject) => {\n          const reader = new FileReader();\n\n          reader.onloadend = () => {\n            // Side Effect\n            cssText = cssText.replace(location, `url(${reader.result})`);\n            resolve([location, reader.result]);\n          };\n\n          reader.onerror = reject;\n          reader.readAsDataURL(blob);\n        }));\n      }); // eslint-disable-next-line promise/no-nesting\n\n      return Promise.all(loadFonts).then(() => cssText);\n    });\n  });\n}\n\nfunction parseCSS(source) {\n  if (source == null) {\n    return [];\n  }\n\n  const result = [];\n  const commentsRegex = /(\\/\\*[\\s\\S]*?\\*\\/)/gi; // strip out comments\n\n  let cssText = source.replace(commentsRegex, '');\n  const keyframesRegex = new RegExp('((@.*?keyframes [\\\\s\\\\S]*?){([\\\\s\\\\S]*?}\\\\s*?)})', 'gi'); // eslint-disable-next-line no-constant-condition\n\n  while (true) {\n    const matches = keyframesRegex.exec(cssText);\n\n    if (matches === null) {\n      break;\n    }\n\n    result.push(matches[0]);\n  }\n\n  cssText = cssText.replace(keyframesRegex, '');\n  const importRegex = /@import[\\s\\S]*?url\\([^)]*\\)[\\s\\S]*?;/gi; // to match css & media queries together\n\n  const combinedCSSRegex = '((\\\\s*?(?:\\\\/\\\\*[\\\\s\\\\S]*?\\\\*\\\\/)?\\\\s*?@media[\\\\s\\\\S]' + '*?){([\\\\s\\\\S]*?)}\\\\s*?})|(([\\\\s\\\\S]*?){([\\\\s\\\\S]*?)})'; // unified regex\n\n  const unifiedRegex = new RegExp(combinedCSSRegex, 'gi'); // eslint-disable-next-line no-constant-condition\n\n  while (true) {\n    let matches = importRegex.exec(cssText);\n\n    if (matches === null) {\n      matches = unifiedRegex.exec(cssText);\n\n      if (matches === null) {\n        break;\n      } else {\n        importRegex.lastIndex = unifiedRegex.lastIndex;\n      }\n    } else {\n      unifiedRegex.lastIndex = importRegex.lastIndex;\n    }\n\n    result.push(matches[0]);\n  }\n\n  return result;\n}\n\nfunction getCSSRules(styleSheets) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const ret = [];\n    const deferreds = []; // First loop inlines imports\n\n    styleSheets.forEach(sheet => {\n      if ('cssRules' in sheet) {\n        try {\n          toArray(sheet.cssRules).forEach((item, index) => {\n            if (item.type === CSSRule.IMPORT_RULE) {\n              let importIndex = index + 1;\n              const url = item.href;\n              const deferred = fetchCSS(url).then(metadata => metadata ? embedFonts(metadata) : '').then(cssText => parseCSS(cssText).forEach(rule => {\n                try {\n                  sheet.insertRule(rule, rule.startsWith('@import') ? importIndex += 1 : sheet.cssRules.length);\n                } catch (error) {\n                  console.error('Error inserting rule from remote css', {\n                    rule,\n                    error\n                  });\n                }\n              })).catch(e => {\n                console.error('Error loading remote css', e.toString());\n              });\n              deferreds.push(deferred);\n            }\n          });\n        } catch (e) {\n          const inline = styleSheets.find(a => a.href == null) || document.styleSheets[0];\n\n          if (sheet.href != null) {\n            deferreds.push(fetchCSS(sheet.href).then(metadata => metadata ? embedFonts(metadata) : '').then(cssText => parseCSS(cssText).forEach(rule => {\n              inline.insertRule(rule, sheet.cssRules.length);\n            })).catch(err => {\n              console.error('Error loading remote stylesheet', err.toString());\n            }));\n          }\n\n          console.error('Error inlining remote css file', e.toString());\n        }\n      }\n    });\n    return Promise.all(deferreds).then(() => {\n      // Second loop parses rules\n      styleSheets.forEach(sheet => {\n        if ('cssRules' in sheet) {\n          try {\n            toArray(sheet.cssRules).forEach(item => {\n              ret.push(item);\n            });\n          } catch (e) {\n            console.error(`Error while reading CSS rules from ${sheet.href}`, e.toString());\n          }\n        }\n      });\n      return ret;\n    });\n  });\n}\n\nfunction getWebFontRules(cssRules) {\n  return cssRules.filter(rule => rule.type === CSSRule.FONT_FACE_RULE).filter(rule => shouldEmbed(rule.style.getPropertyValue('src')));\n}\n\nfunction parseWebFontRules(node) {\n  return __awaiter(this, void 0, void 0, function* () {\n    return new Promise((resolve, reject) => {\n      if (node.ownerDocument == null) {\n        reject(new Error('Provided element is not within a Document'));\n      }\n\n      resolve(toArray(node.ownerDocument.styleSheets));\n    }).then(styleSheets => getCSSRules(styleSheets)).then(getWebFontRules);\n  });\n}\n\nexport function getWebFontCSS(node, options) {\n  return __awaiter(this, void 0, void 0, function* () {\n    return parseWebFontRules(node).then(rules => Promise.all(rules.map(rule => {\n      const baseUrl = rule.parentStyleSheet ? rule.parentStyleSheet.href : null;\n      return embedResources(rule.cssText, baseUrl, options);\n    }))).then(cssTexts => cssTexts.join('\\n'));\n  });\n}\nexport function embedWebFonts(clonedNode, options) {\n  return __awaiter(this, void 0, void 0, function* () {\n    return (options.fontEmbedCSS != null ? Promise.resolve(options.fontEmbedCSS) : getWebFontCSS(clonedNode, options)).then(cssText => {\n      const styleNode = document.createElement('style');\n      const sytleContent = document.createTextNode(cssText);\n      styleNode.appendChild(sytleContent);\n\n      if (clonedNode.firstChild) {\n        clonedNode.insertBefore(styleNode, clonedNode.firstChild);\n      } else {\n        clonedNode.appendChild(styleNode);\n      }\n\n      return clonedNode;\n    });\n  });\n}","map":{"version":3,"mappings":"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","names":["toArray","shouldEmbed","embedResources","cssFetchCache","fetchCSS","url","cache","deferred","window","fetch","then","res","cssText","text","embedFonts","meta","raw","regexUrl","fontLocs","match","loadFonts","map","location","replace","startsWith","URL","href","blob","Promise","resolve","reject","reader","FileReader","onloadend","result","onerror","readAsDataURL","all","parseCSS","source","commentsRegex","keyframesRegex","RegExp","matches","exec","push","importRegex","combinedCSSRegex","unifiedRegex","lastIndex","getCSSRules","styleSheets","ret","deferreds","forEach","sheet","cssRules","item","index","type","CSSRule","IMPORT_RULE","importIndex","metadata","rule","insertRule","length","error","console","catch","e","toString","inline","find","a","document","err","getWebFontRules","filter","FONT_FACE_RULE","style","getPropertyValue","parseWebFontRules","node","ownerDocument","Error","getWebFontCSS","options","rules","baseUrl","parentStyleSheet","cssTexts","join","embedWebFonts","clonedNode","fontEmbedCSS","styleNode","createElement","sytleContent","createTextNode","appendChild","firstChild","insertBefore"],"sources":["../src/embedWebFonts.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}